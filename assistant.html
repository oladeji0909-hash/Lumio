<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0b0f14" />
  <title>Lumio</title>
  <link rel="manifest" href="manifest.json" />
  <!-- Security headers via meta (best-effort for static hosting) -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'nonce-lumio-nonce-1'; style-src 'self' 'nonce-lumio-nonce-1'; img-src 'self' data: blob:; connect-src 'self' https:; media-src 'self' blob:; font-src 'self'; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'" />
  <meta http-equiv="Referrer-Policy" content="no-referrer" />
  <meta http-equiv="Permissions-Policy" content="geolocation=(self), microphone=(self), camera=(self), fullscreen=(self)" />
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin" />
  <style nonce="lumio-nonce-1">
    :root {
      --bg: #0b0f14;
      --panel: #0f1420;
      --panel-2: #0b1220;
      --accent: #4f46e5;
      --accent-2: #22d3ee;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: rgba(255,255,255,0.08);
      --bubble-user: rgba(255,255,255,0.02);
      --bubble-assistant: rgba(79,70,229,0.08);
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 16px;
      --radius-sm: 12px;
      --focus: 0 0 0 2px color-mix(in srgb, var(--accent) 40%, transparent);
      --danger: #ef4444;
      --ok: #10b981;
      --warn: #f59e0b;
    }

    html[data-theme="light"] {
      --bg: #f8fafc;
      --panel: #ffffff;
      --panel-2: #f1f5f9;
      --text: #0f172a;
      --muted: #475569;
      --border: rgba(0,0,0,0.08);
      --bubble-user: #f8fafc;
      --bubble-assistant: #eef2ff;
      --shadow: 0 10px 30px rgba(0,0,0,0.08);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background:
        radial-gradient(1200px 800px at 80% -10%, color-mix(in srgb, var(--accent) 24%, transparent), transparent 60%),
        radial-gradient(1000px 700px at -10% 10%, color-mix(in srgb, var(--accent-2) 20%, transparent), transparent 60%),
        var(--bg);
      color: var(--text);
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-height: 100vh;
    }

    /* Force-hide any [hidden] element */
    [hidden] { display: none !important; }

    header {
      padding: 14px 16px;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0));
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; z-index: 10; backdrop-filter: blur(6px);
    }
    .brand { display: flex; gap: 12px; align-items: center; }
    .logo {
      width: 36px; height: 36px; border-radius: 10px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display: grid; place-items: center; color: white; font-weight: 800;
      box-shadow: 0 8px 24px color-mix(in srgb, var(--accent) 35%, transparent);
      user-select: none;
    }
    .title h1 { margin: 0; font-size: 18px; }
    .title p { margin: 0; font-size: 12px; color: var(--muted); }

    .header-actions { display: flex; gap: 8px; align-items: center; }
    .icon-btn {
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: var(--radius-sm); padding: 8px 10px; cursor: pointer; font-weight: 600;
      transition: transform 0.15s ease, background 0.2s ease, box-shadow 0.2s ease;
    }
    .icon-btn:hover { transform: translateY(-1px); }
    .icon-btn:focus-visible { outline: none; box-shadow: var(--focus); }

    main { max-width: 1040px; width: 100%; margin: 0 auto; padding: 12px; display: grid; gap: 12px; }

    /* Cover (app entry) */
    .cover { display: grid; place-items: center; padding: 24px; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 20px; box-shadow: var(--shadow); padding: 22px; width: min(860px, 96vw); display: grid; gap: 14px; }
    .card header { position: static; border: none; background: transparent; padding: 0; }
    .auth-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .auth-box { background: var(--panel-2); border: 1px solid var(--border); border-radius: 16px; padding: 14px; }
    .auth-box h3 { margin: 0 0 8px 0; }
    .auth-box .row { display: grid; gap: 6px; margin-bottom: 8px; }
    .auth-box input[type="text"], .auth-box input[type="password"] { background: var(--panel); color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; }
    .auth-actions { display: flex; gap: 8px; justify-content: flex-end; }
    .welcome { font-size: 14px; color: var(--muted); }

    /* Chat */
    .chat { background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); border: 1px solid var(--border); border-radius: var(--radius); min-height: 60vh; grid-template-rows: auto 1fr auto; box-shadow: var(--shadow); overflow: hidden; }

    .chips { display: flex; flex-wrap: wrap; gap: 8px; padding: 10px 12px 0 12px; }
    .chip { padding: 8px 12px; border-radius: 999px; border: 1px solid var(--border); background: var(--panel); cursor: pointer; font-size: 12px; }

    .messages { overflow-y: auto; padding: 16px; display: grid; gap: 6px; scroll-behavior: smooth; }

    .day-sep { text-align: center; position: relative; margin: 10px 0; }
    .day-sep span { background: var(--panel); color: var(--muted); padding: 4px 10px; border-radius: 999px; border: 1px solid var(--border); font-size: 11px; }

    .msg { display: grid; grid-template-columns: 38px 1fr; gap: 10px; align-items: start; opacity: 0; transform: translateY(6px); animation: in 250ms ease forwards; }
    .msg.grouped .avatar { visibility: hidden; }
    @keyframes in { to { opacity: 1; transform: translateY(0);} }

    .avatar { width: 38px; height: 38px; border-radius: 50%; display: grid; place-items: center; color: white; font-weight: 800; box-shadow: 0 4px 12px rgba(0,0,0,0.2); user-select: none; }
    .avatar.assistant { background: linear-gradient(135deg, var(--accent), var(--accent-2)); }
    .avatar.user { background: linear-gradient(135deg, #4b5563, #111827); }

    .bubble { background: var(--bubble-assistant); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px 14px; box-shadow: 0 2px 18px rgba(0,0,0,0.12), inset 0 1px 0 rgba(255,255,255,0.03); line-height: 1.55; position: relative; }
    .msg.user .bubble { background: var(--bubble-user); }

    .meta { font-size: 11px; color: var(--muted); margin-top: 6px; }

    .bubble.collapsed { max-height: 240px; overflow: hidden; }
    .fadeout { position: absolute; left: 0; right: 0; bottom: 28px; height: 64px; background: linear-gradient(to bottom, rgba(0,0,0,0), color-mix(in srgb, var(--panel) 70%, transparent)); pointer-events: none; }
    .toggle-more { position: absolute; right: 10px; bottom: 6px; font-size: 12px; color: var(--muted); background: var(--panel); border: 1px solid var(--border); border-radius: 999px; padding: 4px 8px; cursor: pointer; }

    .msg-actions { display: flex; gap: 6px; margin-top: 6px; }
    .msg-actions .mini { font-size: 11px; padding: 6px 8px; border: 1px solid var(--border); background: var(--panel); border-radius: 999px; cursor: pointer; color: var(--muted); }

    .suggestions { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .suggestions .sugg { font-size: 11px; padding: 6px 8px; border: 1px solid var(--border); background: var(--panel-2); border-radius: 999px; cursor: pointer; }

    .composer { border-top: 1px solid var(--border); padding: 10px; display: grid; gap: 8px; background: color-mix(in srgb, var(--panel) 94%, transparent); position: sticky; bottom: 0; }
    .statusbar { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--muted); padding: 0 4px 6px; gap: 10px; }
    .voice-ctrls { display: inline-flex; gap: 6px; align-items: center; }

    .comp-row { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: end; }
    textarea { width: 100%; min-height: 56px; max-height: 220px; resize: vertical; background: var(--panel); color: var(--text); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px 14px; outline: none; transition: box-shadow 0.2s ease, border-color 0.2s ease; }
    textarea:focus-visible { box-shadow: var(--focus); border-color: color-mix(in srgb, var(--accent) 40%, var(--border)); }

    .actions { display: flex; gap: 8px; align-items: center; }
    .btn { appearance: none; border: none; cursor: pointer; padding: 10px 14px; border-radius: var(--radius-sm); font-weight: 700; transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease; }
    .btn.primary { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: white; box-shadow: 0 10px 24px color-mix(in srgb, var(--accent) 35%, transparent); }
    .btn.secondary { background: var(--panel); border: 1px solid var(--border); color: var(--text); font-weight: 600; }
    .btn.warn { background: color-mix(in srgb, var(--warn) 25%, var(--panel)); border: 1px solid color-mix(in srgb, var(--warn) 60%, var(--border)); }
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn:focus-visible { outline: none; box-shadow: var(--focus); }

    footer { text-align: center; color: var(--muted); font-size: 11px; padding: 10px; opacity: 0.7; }

    /* Message content formatting */
    .content p { margin: 0.25em 0; }
    .content code { background: color-mix(in srgb, var(--panel) 80%, transparent); padding: 2px 4px; border-radius: 6px; }
    .content pre { background: color-mix(in srgb, var(--panel) 90%, transparent); padding: 10px; border-radius: 12px; overflow: auto; border: 1px solid var(--border); position: relative; }
    .copy-btn { position: absolute; top: 8px; right: 8px; font-size: 12px; padding: 6px 8px; border-radius: 8px; background: var(--panel-2); border: 1px solid var(--border); color: var(--text); cursor: pointer; }
    .content img { max-width: 100%; border-radius: 10px; border: 1px solid var(--border); display: block; }

    /* Typing/thinking indicator */
    .bubble.typing { display: inline-flex; align-items: center; gap: 8px; }
    .dots { display: inline-flex; gap: 6px; }
    .dots span { width: 6px; height: 6px; border-radius: 50%; background: color-mix(in srgb, var(--accent) 70%, var(--panel)); display: inline-block; animation: bounce 1s infinite ease-in-out; }
    .dots span:nth-child(2) { animation-delay: 0.2s; }
    .dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce { 0%, 80%, 100% { transform: translateY(0); opacity: 0.6; } 40% { transform: translateY(-4px); opacity: 1; } }

    /* Drop overlay */
    .drop-overlay { position: fixed; inset: 0; display: none; place-items: center; background: rgba(0,0,0,0.45); color: white; font-size: 22px; z-index: 50; }
    .drop-overlay.active { display: grid; }

    /* Settings panel (modal) */
    .modal-backdrop { position: fixed; inset: 0; display: none; background: rgba(0,0,0,0.5); z-index: 60; }
    .modal-backdrop.active { display: block; }
    .modal { position: fixed; right: 0; top: 0; height: 100%; width: min(680px, 100%); background: var(--panel); border-left: 1px solid var(--border); box-shadow: var(--shadow); display: none; z-index: 70; }
    .modal.active { display: block; }
    .modal header { position: sticky; top: 0; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; }
    .modal .body { padding: 12px 14px; display: grid; gap: 12px; overflow-y: auto; height: calc(100% - 56px); }
    .field { display: grid; gap: 6px; }
    .field label { font-size: 12px; color: var(--muted); }
    .field input[type="text"], .field input[type="number"], .field textarea, .field select, .field input[type="color"], .field input[type="range"], .field input[type="password"] { background: var(--panel-2); color: var(--text); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 10px 12px; width: 100%; }
    .range-row { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }

    /* Mobile tweaks */
    @media (max-width: 720px) { .auth-grid { grid-template-columns: 1fr; } }
    @media (max-width: 640px) {
      .btn { padding: 10px 12px; }
      textarea { min-height: 64px; }
      .messages { padding-bottom: 90px; }
    }
  </style>
</head>
<body>
  <div id="dropOverlay" class="drop-overlay">Drop files or images to add them to the chat</div>
  <header role="banner">
    <div class="brand">
      <div class="logo" id="assistantAvatar" aria-hidden="true">L</div>
      <div class="title">
        <h1 aria-label="App title">Lumio</h1>
        <p class="welcome" aria-label="Tagline">Always helpful</p>
      </div>
    </div>
    <div class="header-actions">
      <div id="userBadge" class="icon-btn" title="Account" aria-live="polite">Guest</div>
      <button id="themeToggle" class="icon-btn" title="Toggle theme" aria-pressed="false">Theme</button>
      <button id="settingsBtn" class="icon-btn" title="Settings & Prompt" aria-haspopup="dialog">Settings</button>
      <button id="logoutBtn" class="icon-btn" title="Sign out" style="display:none;">Sign out</button>
    </div>
  </header>

  <main role="main">
    <!-- Cover / Auth -->
    <section id="cover" class="cover" aria-label="Welcome">
      <div class="card">
        <header>
          <div style="display:flex; align-items:center; gap:10px;">
            <div class="logo" aria-hidden="true">L</div>
            <div>
              <h2 style="margin:0;">Welcome to Lumio</h2>
              <p class="welcome">Sign in to continue your conversations, or start fresh. Choose your style later in Settings üéõÔ∏è</p>
            </div>
          </div>
        </header>
        <div class="auth-grid">
          <div class="auth-box" aria-label="Sign in">
            <h3>Sign in</h3>
            <div class="row">
              <label for="loginUser">Username</label>
              <input id="loginUser" type="text" placeholder="e.g. abdul" autocomplete="username" />
            </div>
            <div class="row">
              <label for="loginPass">Password</label>
              <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
            </div>
            <div class="auth-actions">
              <button id="loginBtn" class="btn primary">Sign in</button>
            </div>
          </div>
          <div class="auth-box" aria-label="Create account">
            <h3>Create account</h3>
            <div class="row">
              <label for="regUser">Username</label>
              <input id="regUser" type="text" placeholder="choose a username" autocomplete="username" />
            </div>
            <div class="row">
              <label for="regPass">Password</label>
              <input id="regPass" type="password" placeholder="create a password" autocomplete="new-password" />
            </div>
            <div class="row">
              <label for="regPass2">Confirm password</label>
              <input id="regPass2" type="password" placeholder="re-enter password" autocomplete="new-password" />
            </div>
            <div class="auth-actions">
              <button id="registerBtn" class="btn secondary">Register</button>
            </div>
          </div>
        </div>
        <div style="display:flex; justify-content:center; gap:8px; align-items:center; font-size:12px; color:var(--muted);">
          <span>By continuing, you agree to local storage of your chats on this device. Your data is encrypted per account.</span>
        </div>
      </div>
    </section>

    <!-- Chat -->
    <section id="chat" class="chat" aria-live="polite" aria-label="Conversation area" hidden>
      <div class="chips" id="chips"></div>
      <div id="messages" class="messages" role="log" aria-live="polite" aria-atomic="false"></div>
      <div class="composer">
        <div class="statusbar">
          <div id="status">Ready</div>
          <div class="voice-ctrls">
            <label style="display:inline-flex;align-items:center;gap:6px;cursor:pointer;">
              <input type="checkbox" id="ttsToggle" /> Speak replies
            </label>
            <button id="ttsPause" class="btn secondary" title="Pause/Resume TTS">Pause</button>
            <button id="ttsStop" class="btn secondary warn" title="Stop TTS">Stop</button>
          </div>
        </div>
        <div class="comp-row">
          <textarea id="input" placeholder="Type a message‚Ä¶ Use /help for commands. Ctrl/Cmd+Enter to send" aria-label="Message input"></textarea>
          <div class="actions">
            <input id="cameraInput" type="file" accept="image/*" capture="environment" style="display:none;" />
            <button id="cameraBtn" class="btn secondary" title="Capture from camera">Camera</button>
            <button id="micBtn" class="btn secondary" title="Hold to talk (push‚Äëto‚Äëtalk)">Hold to Talk</button>
            <button id="send" class="btn primary">Send</button>
            <button id="clear" class="btn secondary" title="Clear chat">Clear</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    Lumio ‚Äî privacy‚Äëminded and user‚Äëfriendly.
  </footer>

  <!-- Settings / Prompt Modal -->
  <div id="backdrop" class="modal-backdrop"></div>
  <div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <header>
      <strong id="settingsTitle">Settings & System Prompt</strong>
      <button id="closeSettings" class="icon-btn">Close</button>
    </header>
    <div class="body">
      <div class="field">
        <label>Persona / Tone</label>
        <select id="personaSelect">
          <option value="friendly">Friendly üòä</option>
          <option value="playful">Playful üòÑ</option>
          <option value="professional">Professional ‚úçÔ∏è</option>
          <option value="motivational">Motivational üí™</option>
        </select>
        <small class="welcome">Controls phrasing and light emoji usage.</small>
      </div>
      <div class="field range-row">
        <label for="toneLevel">Tone (Casual ‚Üî Formal)</label>
        <input id="toneLevel" type="range" min="0" max="100" step="1" />
      </div>
      <div class="field range-row">
        <label for="creativityLevel">Creativity (Precise ‚Üî Creative)</label>
        <input id="creativityLevel" type="range" min="0" max="100" step="1" />
      </div>
      <div class="field">
        <label>Personal memory (the assistant may reference this)</label>
        <textarea id="memoryInput" rows="3" placeholder="e.g., I‚Äôm learning Python; I prefer concise answers; My timezone is WAT"></textarea>
        <label style="display:flex;gap:8px;align-items:center;margin-top:4px;"><input type="checkbox" id="useMemoryToggle" /> Enable memory usage</label>
      </div>
      <div class="field">
        <label>System Rules (one per line; maker rule is always enforced)</label>
        <textarea id="rulesInput" rows="5"></textarea>
      </div>

      <details>
        <summary>AI Backends (optional; stored encrypted locally)</summary>
        <div class="field">
          <label>Text Model Endpoint (https://...)</label>
          <input id="textEndpoint" type="text" placeholder="https://api.example.com/v1/chat" />
          <label>Text API Key</label>
          <input id="textApiKey" type="password" placeholder="sk-..." />
        </div>
        <div class="field">
          <label>Image Generation Endpoint (https://...)</label>
          <input id="imageEndpoint" type="text" placeholder="https://api.example.com/v1/images" />
          <label>Image API Key</label>
          <input id="imageApiKey" type="password" placeholder="sk-..." />
        </div>
        <div class="field">
          <label>Vision Endpoint (https://...)</label>
          <input id="visionEndpoint" type="text" placeholder="https://api.example.com/v1/vision" />
          <label>Vision API Key</label>
          <input id="visionApiKey" type="password" placeholder="sk-..." />
        </div>
        <div class="field">
          <label>Code Model Endpoint (https://...)</label>
          <input id="codeEndpoint" type="text" placeholder="https://api.example.com/v1/code" />
          <label>Code API Key</label>
          <input id="codeApiKey" type="password" placeholder="sk-..." />
        </div>
        <small class="welcome">Endpoints must be HTTPS and accept Bearer authorization. No data is sent anywhere unless you configure these.</small>
      </details>

      <div style="display:flex; gap:8px; flex-wrap: wrap; margin-top:8px;">
        <div class="field" style="min-width:200px;">
          <label>Accent color</label>
          <input id="accentPicker" type="color" />
        </div>
        <div class="field" style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div>
            <label>Assistant avatar label</label>
            <input id="assistantAvatarInput" type="text" maxlength="2" placeholder="L" />
          </div>
          <div>
            <label>User avatar label</label>
            <input id="userAvatarInput" type="text" maxlength="2" placeholder="U" />
          </div>
        </div>
      </div>

      <div class="field" style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div>
          <label>TTS Voice</label>
          <select id="voiceSelect"></select>
        </div>
        <div>
          <label>Rate</label>
          <input id="voiceRate" type="number" min="0.5" max="2" step="0.1" value="1" />
        </div>
      </div>
      <div class="field" style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div>
          <label>Pitch</label>
          <input id="voicePitch" type="number" min="0" max="2" step="0.1" value="1" />
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
          <input id="persistToggle" type="checkbox" />
          <label for="persistToggle">Persist chat and settings locally (encrypted per account)</label>
        </div>
      </div>

      <div style="display:flex; gap:8px; flex-wrap: wrap;">
        <button id="exportBtn" class="btn secondary">Export conversation</button>
        <label class="btn secondary" for="importFile" style="display:inline-block;">
          Import conversation
          <input id="importFile" type="file" accept="application/json" style="display:none;" />
        </label>
        <button id="resetBtn" class="btn warn">Reset to defaults</button>
      </div>
      <div class="field">
        <details>
          <summary>Command cheatsheet</summary>
          <div class="content" style="font-size: 13px;">
            <p><code>/help</code> Show help</p>
            <p><code>/img a cute robot --w 512 --h 512</code> Generate image (uses backend if configured; otherwise procedural)</p>
            <p><code>/describe</code> Describe the last added or captured image</p>
            <p><code>/explaincode</code> Explain the last code block or code after the command</p>
            <p><code>/fixcode</code> Attempt to correct and format the code</p>
            <p><code>/createcode js|html|python|css My App</code> Generate a starter program</p>
            <p><code>/format</code> Reformat a pasted code block</p>
            <p><code>/calc, /convert, /timer, /weather, /memory, /search</code> Other tools</p>
          </div>
        </details>
      </div>
    </div>
  </div>

  <script nonce="lumio-nonce-1">
    // Security limits and constants
    const MAX_MSG_LEN = 4000;
    const MAX_MESSAGES = 500;
    const MAX_FILES = 10;
    const MAX_FILE_CHARS = 300000;
    const MAX_IMPORT_BYTES = 2_000_000;
    const MAX_IMG_DIM = 1024;

    // Policy and constants
    const POLICY = {
      developerName: 'Abdulrahman',
      baseRules: [
        'You are a helpful, polite AI assistant.',
        'Your developer is Abdulrahman. Do not state or imply any other maker unless explicitly asked about your maker.',
        'Do not hallucinate sources. Prefer neutral phrasing when uncertain.',
        'Be concise, clear, and actionable.'
      ]
    };

    // Elements
    const els = {
      cover: document.getElementById('cover'), chat: document.getElementById('chat'), userBadge: document.getElementById('userBadge'), logoutBtn: document.getElementById('logoutBtn'), messages: document.getElementById('messages'), input: document.getElementById('input'), send: document.getElementById('send'), clear: document.getElementById('clear'), status: document.getElementById('status'), micBtn: document.getElementById('micBtn'), ttsToggle: document.getElementById('ttsToggle'), themeToggle: document.getElementById('themeToggle'), chips: document.getElementById('chips'), cameraBtn: document.getElementById('cameraBtn'), cameraInput: document.getElementById('cameraInput'),
      loginUser: document.getElementById('loginUser'), loginPass: document.getElementById('loginPass'), loginBtn: document.getElementById('loginBtn'), regUser: document.getElementById('regUser'), regPass: document.getElementById('regPass'), regPass2: document.getElementById('regPass2'), registerBtn: document.getElementById('registerBtn'),
      settingsBtn: document.getElementById('settingsBtn'), settingsModal: document.getElementById('settingsModal'), backdrop: document.getElementById('backdrop'), closeSettings: document.getElementById('closeSettings'), rulesInput: document.getElementById('rulesInput'), personaSelect: document.getElementById('personaSelect'), toneLevel: document.getElementById('toneLevel'), creativityLevel: document.getElementById('creativityLevel'), memoryInput: document.getElementById('memoryInput'), useMemoryToggle: document.getElementById('useMemoryToggle'), accentPicker: document.getElementById('accentPicker'), assistantAvatar: document.getElementById('assistantAvatar'), assistantAvatarInput: document.getElementById('assistantAvatarInput'), userAvatarInput: document.getElementById('userAvatarInput'), voiceSelect: document.getElementById('voiceSelect'), voiceRate: document.getElementById('voiceRate'), voicePitch: document.getElementById('voicePitch'), persistToggle: document.getElementById('persistToggle'), exportBtn: document.getElementById('exportBtn'), importFile: document.getElementById('importFile'), resetBtn: document.getElementById('resetBtn'), dropOverlay: document.getElementById('dropOverlay'), ttsPause: document.getElementById('ttsPause'), ttsStop: document.getElementById('ttsStop'),
      textEndpoint: document.getElementById('textEndpoint'), textApiKey: document.getElementById('textApiKey'), imageEndpoint: document.getElementById('imageEndpoint'), imageApiKey: document.getElementById('imageApiKey'), visionEndpoint: document.getElementById('visionEndpoint'), visionApiKey: document.getElementById('visionApiKey'), codeEndpoint: document.getElementById('codeEndpoint'), codeApiKey: document.getElementById('codeApiKey'),
    };

    // Settings and state
    const defaultSettings = {
      theme: 'dark', accent: '#4f46e5', accent2: '#22d3ee', assistantAvatarLabel: 'L', userAvatarLabel: 'U', tts: false, ttsVoice: '', ttsRate: 1, ttsPitch: 1, persist: true, extraRules: [], persona: 'friendly', tone: 30, creativity: 40, memory: '', useMemory: true,
      textEndpoint: '', textApiKey: '', imageEndpoint: '', imageApiKey: '', visionEndpoint: '', visionApiKey: '', codeEndpoint: '', codeApiKey: ''
    };

    let settings = { ...defaultSettings };
    let currentUser = null; // username
    let currentEncKey = null; // CryptoKey for AES-GCM per user

    const state = { messages: [], timers: [], files: [], lastImageDataUrl: '' };

    function storageKey(prefix) { return `${prefix}__${currentUser||'guest'}`; }

    // WebCrypto helpers
    const enc = new TextEncoder(); const dec = new TextDecoder();
    function b64(buf) { return btoa(String.fromCharCode(...new Uint8Array(buf))); }
    function b64toBuf(b64s){ const bin = atob(b64s); const u8 = new Uint8Array(bin.length); for (let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i); return u8.buffer; }

    async function deriveKey(password, saltB64, usages=['encrypt','decrypt']) {
      const salt = saltB64 ? b64toBuf(saltB64) : crypto.getRandomValues(new Uint8Array(16)).buffer;
      const baseKey = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey','deriveBits']);
      const key = await crypto.subtle.deriveKey({ name:'PBKDF2', salt, iterations: 200000, hash:'SHA-256' }, baseKey, { name:'AES-GCM', length: 256 }, false, usages);
      return { key, saltB64: b64(salt) };
    }
    async function hashPassword(password, saltB64) {
      const salt = saltB64 ? b64toBuf(saltB64) : crypto.getRandomValues(new Uint8Array(16)).buffer;
      const baseKey = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveBits']);
      const bits = await crypto.subtle.deriveBits({ name:'PBKDF2', salt, iterations: 150000, hash:'SHA-256' }, baseKey, 256);
      return { hashB64: b64(bits), saltB64: b64(salt) };
    }
    async function encryptJSON(obj) {
      if (!currentEncKey) return JSON.stringify(obj);
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const data = enc.encode(JSON.stringify(obj));
      const cipher = await crypto.subtle.encrypt({ name:'AES-GCM', iv }, currentEncKey, data);
      return JSON.stringify({ enc:true, iv:b64(iv.buffer), ct:b64(cipher) });
    }
    async function decryptJSON(s) {
      try {
        const j = JSON.parse(s);
        if (!j || !j.enc) return j;
        if (!currentEncKey) throw new Error('Missing key');
        const iv = b64toBuf(j.iv); const ct = b64toBuf(j.ct);
        const plain = await crypto.subtle.decrypt({ name:'AES-GCM', iv:new Uint8Array(iv) }, currentEncKey, ct);
        return JSON.parse(dec.decode(plain));
      } catch { return null; }
    }

    // Sanitization helpers
    function clamp(n, min, max){ return Math.min(max, Math.max(min, n)); }
    function safeString(s, max=MAX_MSG_LEN){ if (typeof s !== 'string') return ''; const t = s.slice(0, max); return t; }
    function sanitizeMessage(m){ const r = (m && typeof m==='object') ? m : {}; const role = r.role==='assistant' ? 'assistant' : 'user'; return { role, content: safeString(r.content||'', MAX_MSG_LEN), ts: Number.isFinite(r.ts)? r.ts : Date.now() }; }
    function sanitizeMessages(arr){ if (!Array.isArray(arr)) return []; const out=[]; for (const m of arr.slice(-MAX_MESSAGES)){ out.push(sanitizeMessage(m)); } return out; }
    function httpsOrEmpty(url){ if(!url) return ''; try{ const u=new URL(url); return (u.protocol==='https:') ? url : ''; } catch { return ''; } }
    function sanitizeSettings(obj){ const o = (obj && typeof obj==='object') ? obj : {}; const personas = ['friendly','playful','professional','motivational']; return {
        theme: o.theme==='light' ? 'light' : 'dark',
        accent: /^#?[0-9a-fA-F]{6}$/.test(o.accent||'') ? (o.accent.startsWith('#')?o.accent:'#'+o.accent) : defaultSettings.accent,
        accent2: /^#?[0-9a-fA-F]{6}$/.test(o.accent2||'') ? (o.accent2.startsWith('#')?o.accent2:'#'+o.accent2) : defaultSettings.accent2,
        assistantAvatarLabel: safeString(o.assistantAvatarLabel||'L', 2),
        userAvatarLabel: safeString(o.userAvatarLabel||'U', 2),
        tts: !!o.tts,
        ttsVoice: safeString(o.ttsVoice||'', 100),
        ttsRate: clamp(parseFloat(o.ttsRate)||1, 0.5, 2),
        ttsPitch: clamp(parseFloat(o.ttsPitch)||1, 0, 2),
        persist: !!o.persist,
        extraRules: Array.isArray(o.extraRules) ? o.extraRules.map(x=>safeString(x,200)).slice(0,50) : [],
        persona: personas.includes(o.persona) ? o.persona : 'friendly',
        tone: clamp(parseInt(o.tone,10)||30, 0, 100),
        creativity: clamp(parseInt(o.creativity,10)||40, 0, 100),
        memory: safeString(o.memory||'', 4000),
        useMemory: !!o.useMemory,
        textEndpoint: httpsOrEmpty(o.textEndpoint||''), textApiKey: safeString(o.textApiKey||'', 200),
        imageEndpoint: httpsOrEmpty(o.imageEndpoint||''), imageApiKey: safeString(o.imageApiKey||'', 200),
        visionEndpoint: httpsOrEmpty(o.visionEndpoint||''), visionApiKey: safeString(o.visionApiKey||'', 200),
        codeEndpoint: httpsOrEmpty(o.codeEndpoint||''), codeApiKey: safeString(o.codeApiKey||'', 200),
      }; }

    // Persistence per-user (encrypted)
    async function load() {
      try {
        const savedSettingsRaw = localStorage.getItem(storageKey('assistant_settings'));
        if (savedSettingsRaw) {
          const maybeDec = await decryptJSON(savedSettingsRaw);
          settings = { ...defaultSettings, ...(maybeDec ? sanitizeSettings(maybeDec) : sanitizeSettings(JSON.parse(savedSettingsRaw)||{})) };
        } else settings = { ...defaultSettings };

        const savedRaw = localStorage.getItem(storageKey('assistant_state'));
        if (savedRaw) {
          const maybeDec = await decryptJSON(savedRaw);
          const saved = maybeDec || JSON.parse(savedRaw);
          state.messages = (saved && Array.isArray(saved.messages) && saved.messages.length) ? sanitizeMessages(saved.messages) : [ { role:'assistant', content: greet(), ts: Date.now() } ];
          state.timers = saved && Array.isArray(saved.timers) ? saved.timers : [];
          state.files = saved && Array.isArray(saved.files) ? saved.files.slice(-MAX_FILES).map(f=>({ name: safeString(f.name||'file',120), text: safeString(f.text||'', MAX_FILE_CHARS) })) : [];
          state.lastImageDataUrl = (saved && typeof saved.lastImageDataUrl==='string') ? saved.lastImageDataUrl.slice(0, 1_500_000) : '';
        } else {
          state.messages = [ { role:'assistant', content: greet(), ts: Date.now() } ];
          state.timers = []; state.files = []; state.lastImageDataUrl = '';
        }
      } catch (e) {
        console.warn('Load failed', e); settings = { ...defaultSettings }; state.messages = [ { role:'assistant', content: greet(), ts: Date.now() } ]; state.timers = []; state.files = []; state.lastImageDataUrl = '';
      }
      applySettingsToUI(); applyTheme(); applyAccent(settings.accent, settings.accent2); renderChips();
    }
    async function save() {
      if (!settings.persist) return;
      if (state.messages.length > MAX_MESSAGES) state.messages = state.messages.slice(-MAX_MESSAGES);
      if (state.files.length > MAX_FILES) state.files = state.files.slice(-MAX_FILES);
      const toSave = { messages: state.messages.filter(m=>!m.typing), timers: state.timers, files: state.files, lastImageDataUrl: state.lastImageDataUrl };
      localStorage.setItem(storageKey('assistant_settings'), await encryptJSON(settings));
      localStorage.setItem(storageKey('assistant_state'), await encryptJSON(toSave));
    }

    // Accounts (local; demo only ‚Äî encrypted)
    function getUsers() { try { return JSON.parse(localStorage.getItem('assistant_users')||'{}'); } catch { return {}; } }
    function setUsers(db) { localStorage.setItem('assistant_users', JSON.stringify(db)); }

    async function register(username, password, password2) {
      username = (username||'').trim().toLowerCase();
      if (!username || !password) return alert('Username and password are required.');
      if (password !== password2) return alert('Passwords do not match.');
      if (password.length < 8) return alert('Use at least 8 characters.');
      const db = getUsers(); if (db[username]) return alert('User already exists.');
      const { hashB64, saltB64 } = await hashPassword(password);
      const { saltB64: encSalt } = await deriveKey(password); // derive once to get salt; key discarded
      db[username] = { passHash: hashB64, passSalt: saltB64, encSalt };
      setUsers(db);
      alert('Account created! You can sign in now.');
    }

    async function login(username, password) {
      username = (username||'').trim().toLowerCase();
      const db = getUsers(); const rec = db[username];
      if (!rec) return alert('Invalid credentials.');
      const { hashB64 } = await hashPassword(password, rec.passSalt);
      if (hashB64 !== rec.passHash) return alert('Invalid credentials.');
      const { key } = await deriveKey(password, rec.encSalt);
      currentEncKey = key; currentUser = username; enterApp();
    }

    function logout() { currentUser = null; currentEncKey = null; leaveApp(); }

    async function enterApp() {
      // ensure cover is hidden and chat shown
      els.cover.hidden = true; els.chat.hidden = false;
      els.cover.style.display = 'none'; els.chat.style.display = 'grid';
      els.logoutBtn.style.display = 'inline-block'; els.userBadge.textContent = currentUser || 'Guest';
      await load(); render();
    }
    function leaveApp() {
      // ensure chat is hidden and cover shown
      els.chat.hidden = true; els.cover.hidden = false;
      els.chat.style.display = 'none'; els.logoutBtn.style.display = 'none'; els.userBadge.textContent = 'Guest';
    }

    // UI setup
    function applySettingsToUI() {
      document.documentElement.setAttribute('data-theme', settings.theme);
      els.ttsToggle.checked = !!settings.tts;
      els.assistantAvatar.textContent = settings.assistantAvatarLabel || 'L';
      els.assistantAvatarInput.value = settings.assistantAvatarLabel;
      els.userAvatarInput.value = settings.userAvatarLabel;
      els.accentPicker.value = settings.accent;
      els.voiceRate.value = settings.ttsRate; els.voicePitch.value = settings.ttsPitch;
      els.persistToggle.checked = settings.persist;
      els.rulesInput.value = (settings.extraRules || []).join('\n');
      els.personaSelect.value = settings.persona || 'friendly';
      els.toneLevel.value = settings.tone; els.creativityLevel.value = settings.creativity;
      els.memoryInput.value = settings.memory || ''; els.useMemoryToggle.checked = !!settings.useMemory;
      els.textEndpoint.value = settings.textEndpoint; els.textApiKey.value = settings.textApiKey;
      els.imageEndpoint.value = settings.imageEndpoint; els.imageApiKey.value = settings.imageApiKey;
      els.visionEndpoint.value = settings.visionEndpoint; els.visionApiKey.value = settings.visionApiKey;
      els.codeEndpoint.value = settings.codeEndpoint; els.codeApiKey.value = settings.codeApiKey;
    }

    function applyTheme() { document.documentElement.setAttribute('data-theme', settings.theme); els.themeToggle.textContent = settings.theme === 'dark' ? 'Light' : 'Dark'; }

    function hexToHsl(hex) { const m = hex.replace('#',''); const bigint = parseInt(m, 16); const r = (bigint >> 16) & 255, g = (bigint >> 8) & 255, b = bigint & 255; const r1=r/255,g1=g/255,b1=b/255; const max=Math.max(r1,g1,b1), min=Math.min(r1,g1,b1); let h,s,l=(max+min)/2; if (max===min){h=s=0;} else { const d=max-min; s=l>0.5?d/(2-max-min):d/(max+min); switch(max){case r1:h=(g1-b1)/d+(g1<b1?6:0);break;case g1:h=(b1-r1)/d+2;break;case b1:h=(r1-g1)/d+4;break;} h/=6;} return [h*360,s,l]; }
    function hslToHex(h,s,l){ h/=360; let r,g,b; if(s===0){r=g=b=l;} else { const hue2rgb=(p,q,t)=>{ if(t<0) t+=1; if(t>1) t-=1; if(t<1/6) return p+(q-p)*6*t; if(t<1/2) return q; if(t<2/3) return p+(q-p)*(2/3 - t)*6; return p; }; const q = l < 0.5 ? l*(1+s) : l + s - l*s; const p = 2*l - q; r=hue2rgb(p,q,h+1/3); g=hue2rgb(p,q,h); b=hue2rgb(p,q,h-1/3);} const toHex=x=>('0'+Math.round(x*255).toString(16)).slice(-2); return `#${toHex(r)}${toHex(g)}${toHex(b)}`; }
    function lighten(hex, amt=0.2){ const [h,s,l]=hexToHsl(hex); return hslToHex(h,s,Math.min(1,l+amt)); }
    function applyAccent(acc, acc2){ settings.accent=acc; settings.accent2=acc2||lighten(acc,0.25); document.documentElement.style.setProperty('--accent', settings.accent); document.documentElement.style.setProperty('--accent-2', settings.accent2); }

    // Markdown renderer (safe, minimal)
    function escapeHtml(str){ return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;'); }
    function renderMarkdown(md){ let s = escapeHtml(md);
      s = s.replace(/!\[([^\]]*)\]\((https?:[^\s)]+|data:image\/[a-zA-Z+]+;base64,[^\s)]+)\)/g, '<img alt="$1" src="$2" />');
      s = s.replace(/```([\w+-]*)\n([\s\S]*?)```/g,(m,lang,code)=>`<pre data-lang="${lang||''}"><button class=\"copy-btn\" data-copy>Copy</button><code>${code.replace(/\n/g,'\n')}</code></pre>`);
      s = s.replace(/`([^`]+)`/g,'<code>$1</code>');
      s = s.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>');
      s = s.replace(/\*([^*]+)\*/g,'<em>$1</em>');
      s = s.replace(/\[([^\]]+)\]\((https?:[^\s)]+)\)/g,'<a href=\"$2\" target=\"_blank\" rel=\"noopener\">$1</a>');
      s = s.split(/\n{2,}/).map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join(''); return s; }

    // Guardrails
    function enforcePolicy(text, isAssistantOutput=false){ let out=text; const explicitMakerAsk=/\b(who\s+(built|made|created)\s+you|who\s+is\s+(your\s+)?(maker|developer))\b/i.test(out); if(!explicitMakerAsk){ if(isAssistantOutput){ out=out.replace(/\b(openai|google|meta|anthropic|microsoft|x\s?ai|xai|amazon)\b/ig,''); out=out.replace(/\b(company|org(anization)?|corporation|startup)\b/ig,''); out=out.replace(/\s{2,}/g,' ').trim(); }} return out; }

    // Simple moderation
    const banned = [/\b(violence|explosive|bomb|hate|terror)\b/i];
    function checkModeration(text){ return banned.some(r=>r.test(text)); }

    // Persona and tone helpers
    function greet(){ switch(settings.persona){ case 'playful': return 'Hi! I\'m your AI buddy. What are we exploring today? üòÑ'; case 'professional': return 'Hello. How may I assist you today?'; case 'motivational': return 'Welcome! Ready to make progress together? üí™'; default: return 'Hello! How can I help today? üòä'; }}
    function withPersona(text){ const tone=settings.persona||'friendly'; let t=text; const add=e=>{ t += ` ${e}`; }; const casual = settings.tone <= 33; const formal = settings.tone >= 67; if (tone==='playful') { if (casual) t = t.replace(/\b(hello|hi)\b/i,'Hey'); add('üòÑ'); } else if (tone==='motivational') { t += ' You\'ve got this!'; add('üí™'); } else if (tone==='professional') { if (casual) t = 'Certainly. ' + t; } else { if (!formal && !/[.!?]$/.test(t)) t += '!'; add('üòä'); } if (settings.creativity>70) t += ' ‚ú®'; return t; }

    // Backend calls (optional)
    async function callJson(endpoint, key, payload){ const res = await fetch(endpoint, { method:'POST', headers: { 'Content-Type':'application/json', ...(key?{ 'Authorization':`Bearer ${key}` }:{}) }, body: JSON.stringify(payload) }); if (!res.ok) throw new Error('API error'); return res.json(); }
    async function callTextModel(prompt, history){ if (!settings.textEndpoint) return null; try { return await callJson(settings.textEndpoint, settings.textApiKey, { prompt, history }); } catch { return null; } }
    async function callImageModel(prompt, w, h){ if (!settings.imageEndpoint) return null; try { return await callJson(settings.imageEndpoint, settings.imageApiKey, { prompt, width:w, height:h }); } catch { return null; } }
    async function callVisionModel(imageDataUrl, task){ if (!settings.visionEndpoint) return null; try { return await callJson(settings.visionEndpoint, settings.visionApiKey, { image: imageDataUrl, task }); } catch { return null; } }
    async function callCodeModel(task, code, lang){ if (!settings.codeEndpoint) return null; try { return await callJson(settings.codeEndpoint, settings.codeApiKey, { task, code, lang }); } catch { return null; } }

    // Image utilities
    function drawProcedural(prompt, w, h){ const cnv=document.createElement('canvas'); cnv.width=w; cnv.height=h; const ctx=cnv.getContext('2d'); const g=ctx.createLinearGradient(0,0,w,h); g.addColorStop(0, getCss('--accent')); g.addColorStop(1, getCss('--accent-2')); ctx.fillStyle=g; ctx.fillRect(0,0,w,h); ctx.globalAlpha=0.35; ctx.fillStyle='#fff'; for(let i=0;i<6;i++){ ctx.beginPath(); const amp=20+Math.random()*60; const y0=(h/6)*i+20; ctx.moveTo(0,y0); for(let x=0;x<=w;x+=8){ const y=y0+Math.sin((x/50)+(i*0.8))*amp; ctx.lineTo(x,y); } ctx.lineTo(w,h); ctx.lineTo(0,h); ctx.closePath(); ctx.fill(); } ctx.globalAlpha=1; ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.font=`${Math.round(w*0.06)}px system-ui, sans-serif`; ctx.textAlign='center'; ctx.textBaseline='middle'; const text=(prompt||'Lumio').slice(0,40); ctx.fillText(text, w/2, h*0.9); return cnv.toDataURL('image/png'); }
    function getCss(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim() || '#4f46e5'; }
    async function fileToDataUrl(file, maxDim=MAX_IMG_DIM){ const img=await new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); return await resizeDataUrl(img, maxDim); }
    async function resizeDataUrl(dataUrl, maxDim=MAX_IMG_DIM){ return new Promise((res)=>{ const img=new Image(); img.onload=()=>{ const scale=Math.min(1, maxDim/Math.max(img.width,img.height)); const w=Math.round(img.width*scale); const h=Math.round(img.height*scale); const cnv=document.createElement('canvas'); cnv.width=w; cnv.height=h; const ctx=cnv.getContext('2d'); ctx.drawImage(img,0,0,w,h); res(cnv.toDataURL('image/png', 0.9)); }; img.src=dataUrl; }); }

    // Code utilities
    function extractCodeBlocks(text){ const re=/```([\w+-]*)\n([\s\S]*?)```/g; const out=[]; let m; while((m=re.exec(text))){ out.push({ lang:(m[1]||'').toLowerCase(), code:m[2] }); } return out; }
    function guessLangFrom(filenameOrCode){ const s=(filenameOrCode||'').toLowerCase(); if (s.endsWith('.py')||/\bdef\s+\w+\s*\(/.test(s)) return 'python'; if (s.endsWith('.js')||/function\s+\w+\(/.test(s)) return 'javascript'; if (s.endsWith('.ts')) return 'typescript'; if (s.endsWith('.html')||/<html[\s>]/i.test(s)) return 'html'; if (s.endsWith('.css')||/\{\s*[\w-]+\s*:\s*[^}]+;/.test(s)) return 'css'; return 'text'; }
    function explainCodeLocal(code, lang){ const lines=code.split(/\n/); const fns=[...code.matchAll(/function\s+(\w+)/g)].map(m=>m[1]); const cls=[...code.matchAll(/class\s+(\w+)/g)].map(m=>m[1]); const imps=[...code.matchAll(/^(?:import|from)\s+([^\n]+)/mg)].map(m=>m[1].trim()); const exps=[...code.matchAll(/export\s+(?:default\s+)?(\w+)/g)].map(m=>m[1]); let out=`Code overview (${lang}, ${lines.length} lines):\n`; if (imps.length) out+=`- Imports: ${imps.slice(0,5).join('; ')}\n`; if (fns.length) out+=`- Functions: ${fns.slice(0,8).join(', ')}\n`; if (cls.length) out+=`- Classes: ${cls.slice(0,5).join(', ')}\n`; if (exps.length) out+=`- Exports: ${exps.join(', ')}\n`; out+='Potential improvements:\n- Add docstrings/comments where missing.\n- Validate inputs and handle errors.\n- Break up large functions.\n- Add tests for critical logic.'; return out; }
    function fixCodeLocal(code, lang){ let c=code.replace(/\t/g,'  '); c=c.replace(/[ \t]+$/gm,''); if (lang==='html'){ c=c.replace(/>\s+</g,'>\n<'); } const braces=(c.match(/[{}]/g)||[]).reduce((a,ch)=>{ if(ch==='{') a++; else a--; return a; },0); const parens=(c.match(/[()]/g)||[]).reduce((a,ch)=>{ if(ch==='(') a++; else a--; return a; },0); const brackets=(c.match(/[\[\]]/g)||[]).reduce((a,ch)=>{ if(ch==='[') a++; else a--; return a; },0); let note=''; if (braces!==0||parens!==0||brackets!==0){ note += `Note: Unbalanced delimiters => { }: ${braces}, ( ): ${parens}, [ ]: ${brackets}. Please verify.`; } return { fixed:c, note }; }
    function createCodeTemplate(kind, name){ name = name || 'App'; switch((kind||'').toLowerCase()){ case 'js': case 'javascript': return `// ${name}\nfunction main(){ console.log('Hello from ${name}'); }\nmain();`; case 'python': return `# ${name}\nif __name__ == '__main__':\n    print('Hello from ${name}')`; case 'css': return `/* ${name} */\n:root{ --accent:#4f46e5;}\nbody{font-family:system-ui;background:#0b0f14;color:#e5e7eb;}`; case 'html': default: return `<!doctype html>\n<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'><title>${name}</title><style>body{font-family:system-ui;padding:20px}</style></head><body><h1>${name}</h1><script>console.log('Hello from ${name}')<\\/script></body></html>`; } }

    // Commands and local tools
    function commandHelp(){ return ['Commands:', '/img a cute robot --w 512 --h 512', '/describe (describe last image)', '/explaincode', '/fixcode', '/createcode js|html|python|css Name', '/format', '/calc 2*(3+4)', '/convert 10 km to mi', '/timer 5m Take a break', '/weather Lagos | /weather here', '/memory add key: value | /memory show | /memory clear', '/search keyword', 'Or use patterns: Summarize: ..., Todo: a, b, c'].join('\n'); }

    function parseOpts(s){ const m=[...s.matchAll(/--(\w+)\s+(\S+)/g)]; const o={}; m.forEach(kv=>o[kv[1]]=kv[2]); return o; }

    async function imgCommand(rest){ const opts=parseOpts(rest); const prompt=rest.replace(/--\w+\s+\S+/g,'').trim()||'Lumio'; const w=clamp(parseInt(opts.w,10)||512, 64, 1024); const h=clamp(parseInt(opts.h,10)||512, 64, 1024); let outUrl=''; const remote=await callImageModel(prompt,w,h); if (remote && remote.url) { outUrl=remote.url; } else if (remote && remote.b64) { outUrl = `data:image/png;base64,${remote.b64}`; } else { outUrl = drawProcedural(prompt,w,h); } state.lastImageDataUrl = outUrl; return `Here is your image:\n\n![${escapeHtml(prompt)}](${outUrl})`; }

    async function describeCommand(){ if (!state.lastImageDataUrl) return 'No image available. Add one by dropping it here, using Camera, or generating with /img.'; const remote = await callVisionModel(state.lastImageDataUrl, 'describe'); if (remote && remote.description) return withPersona(`Description: ${remote.description}`); const meta = await imageMetadata(state.lastImageDataUrl); return withPersona(`Image ${meta.width}x${meta.height}, dominant colors: ${meta.colors.join(', ')}`); }

    async function imageMetadata(dataUrl){ return new Promise((res)=>{ const img=new Image(); img.onload=()=>{ const cnv=document.createElement('canvas'); cnv.width=img.width; cnv.height=img.height; const ctx=cnv.getContext('2d'); ctx.drawImage(img,0,0); const { data } = ctx.getImageData(0,0,Math.min(64,img.width),Math.min(64,img.height)); const buckets={}; for(let i=0;i<data.length;i+=4){ const r=data[i], g=data[i+1], b=data[i+2]; const key = `${Math.round(r/32)*32},${Math.round(g/32)*32},${Math.round(b/32)*32}`; buckets[key]=(buckets[key]||0)+1; } const top=Object.entries(buckets).sort((a,b)=>b[1]-a[1]).slice(0,5).map(x=>`rgb(${x[0]})`); res({ width: img.width, height: img.height, colors: top }); }; img.src=dataUrl; }); }

    function getLastCode(){ for (let i=state.messages.length-1;i>=0;i--){ const cbs=extractCodeBlocks(state.messages[i].content||''); if (cbs.length) return cbs[cbs.length-1]; } return null; }

    async function explainCodeCommand(rest){ const explicit=extractCodeBlocks(rest); let code='', lang=''; if (explicit.length) { code=explicit[0].code; lang=explicit[0].lang; } else { const last=getLastCode(); if (!last) return 'No code block found. Paste code in triple backticks ```lang ...```.'; code=last.code; lang=last.lang; } const remote = await callCodeModel('explain', code, lang); if (remote && remote.explanation) return withPersona(remote.explanation); return withPersona(explainCodeLocal(code, lang||guessLangFrom(code))); }

    async function fixCodeCommand(rest){ const explicit=extractCodeBlocks(rest); let code='', lang=''; if (explicit.length) { code=explicit[0].code; lang=explicit[0].lang; } else { const last=getLastCode(); if (!last) return 'No code block found. Paste code in triple backticks.'; code=last.code; lang=last.lang; } const remote = await callCodeModel('fix', code, lang); if (remote && remote.fixed) return 'Proposed fix:\n\n```'+(lang||'')+'\n'+remote.fixed+'\n```'; const fix=fixCodeLocal(code, lang||guessLangFrom(code)); return 'Proposed fix:\n\n```'+(lang||'')+'\n'+fix.fixed+'\n```'+(fix.note?`\n\n${fix.note}`:''); }

    async function createCodeCommand(rest){ const parts=rest.trim().split(/\s+/); const kind=parts.shift()||'html'; const name=parts.join(' ')||'App'; const remote=await callCodeModel('create', name, kind); if (remote && remote.code) return 'Here is a starter:\n\n```'+(kind||'')+'\n'+remote.code+'\n```'; const code=createCodeTemplate(kind, name); return 'Here is a starter:\n\n```'+(kind||'')+'\n'+code+'\n```'; }

    async function formatCodeCommand(rest){ const explicit=extractCodeBlocks(rest); let code='', lang=''; if (explicit.length) { code=explicit[0].code; lang=explicit[0].lang; } else { const last=getLastCode(); if (!last) return 'No code block found. Paste code in triple backticks.'; code=last.code; lang=last.lang; } const fix=fixCodeLocal(code, lang||guessLangFrom(code)); return 'Formatted:\n\n```'+(lang||'')+'\n'+fix.fixed+'\n```'+(fix.note?`\n\n${fix.note}`:''); }

    function calcCommand(expr){ const safe=expr.replace(/\^/g,'**').replace(/[^0-9+\-*/%().,\s**]/g,''); try{ const val=Function('"use strict"; return ('+safe+')')(); if(typeof val==='number'&&isFinite(val)) return `Result: ${val} ‚úÖ`; return 'Calculation error.'; } catch { return 'Calculation error.'; } }
    function convertCommand(s){ const m=s.match(/(-?\d+(?:\.\d+)?)\s*([a-zA-Z¬∞]+)\s*(?:to|in)\s*([a-zA-Z¬∞]+)/); if(!m) return 'Format: /convert 10 km to mi'; const val=parseFloat(m[1]); const from=m[2].toLowerCase(); const to=m[3].toLowerCase(); const temp=['c','f','k','¬∞c','¬∞f']; if(temp.includes(from)||temp.includes(to)){ const cfrom=from.replace('¬∞',''); const cto=to.replace('¬∞',''); let c; if(cfrom==='c') c=val; else if(cfrom==='f') c=(val-32)*5/9; else if(cfrom==='k') c=val-273.15; else return 'Unsupported temperature unit.'; let out; if(cto==='c') out=c; else if(cto==='f') out=c*9/5+32; else if(cto==='k') out=c+273.15; else return 'Unsupported temperature unit.'; return `${val} ${from} = ${out.toFixed(2)} ${to} üå°Ô∏è`; } const len={ m:1, km:1000, cm:0.01, mm:0.001, mi:1609.344, ft:0.3048, in:0.0254, yard:0.9144, yd:0.9144 }; if(from in len && to in len){ const meters=val*len[from]; return `${val} ${from} = ${(meters/len[to]).toFixed(4)} ${to} üìè`; } const mass={ kg:1, g:0.001, lb:0.45359237, oz:0.0283495231 }; if(from in mass && to in mass){ const kg=val*mass[from]; return `${val} ${from} = ${(kg/mass[to]).toFixed(4)} ${to} ‚öñÔ∏è`; } return 'Unsupported units.'; }
    function timerCommand(s){ const m=s.trim().match(/(\d+)(s|m|h)\s*(.*)/i); if(!m) return 'Format: /timer 5m Take a break'; const n=parseInt(m[1],10); const unit=m[2].toLowerCase(); const label=m[3]||'Timer'; let ms=n*1000; if(unit==='m') ms*=60; if(unit==='h') ms*=60*60; setTimeout(()=>{ pushAssistant(`‚è∞ Timer: ${label}`); tryNotify(`Timer: ${label}`); save(); }, ms); return `Timer set for ${m[1]}${unit}: ${label} ‚è±Ô∏è`; }
    async function weatherCommand(q){ const city=q.trim(); if(!city) return 'Usage: /weather City'; if(city.toLowerCase()==='here' && navigator.geolocation){ try{ const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{ enableHighAccuracy:true, timeout:8000 })); const { latitude, longitude } = pos.coords; const w=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m`); const wj=await w.json(); const c=wj.current; return `Weather here:\n- Temp: ${c.temperature_2m}¬∞C\n- Humidity: ${c.relative_humidity_2m}%\n- Wind: ${c.wind_speed_10m} km/h ‚òÅÔ∏è`; } catch { return 'Location error.'; } }
      try{ const g=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1`); const gj=await g.json(); if(!gj.results||!gj.results.length) return `No results for ${city}.`; const loc=gj.results[0]; const w=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${loc.latitude}&longitude=${loc.longitude}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m`); const wj=await w.json(); const c=wj.current; return `Weather for ${loc.name}, ${loc.country_code}:\n- Temp: ${c.temperature_2m}¬∞C\n- Humidity: ${c.relative_humidity_2m}%\n- Wind: ${c.wind_speed_10m} km/h ‚òÅÔ∏è`; } catch { return 'Weather service error.'; }
    }

    function memoryCommand(s){ const t=s.trim(); if(t.startsWith('add ')){ const kv=t.slice(4).split(':'); if(kv.length>=2){ const k=kv[0].trim(); const v=kv.slice(1).join(':').trim(); const lines=(settings.memory||'').split(/\n/).filter(Boolean); lines.push(`${k}: ${v}`); settings.memory=lines.join('\n'); save(); return withPersona(`Saved memory: ${k}.`); } return 'Format: /memory add key: value'; } if (t==='show') return settings.memory?`Memory:\n${settings.memory}`:'No memory set.'; if (t==='clear'){ settings.memory=''; save(); return 'Memory cleared.'; } return 'Usage: /memory add key: value | /memory show | /memory clear'; }
    function searchCommand(q){ const term=q.trim().toLowerCase(); if(!term) return 'Usage: /search keyword'; const matches=[]; for (const f of state.files){ const lines=f.text.split(/\n/); lines.forEach((ln,i)=>{ if (ln.toLowerCase().includes(term)) matches.push(`${f.name} #${i+1}: ${ln.slice(0,160)}`); }); } return matches.length?`Matches for "${term}":\n- ${matches.slice(0,20).join('\n- ')}`:'No matches in added files.'; }

    function localReply(userText){ const text=userText.trim(); if(!text) return ''; const t=text.toLowerCase(); if(checkModeration(text)) return 'I can\'t help with that. Let\'s try a safer request.';
      if (t==='/help') return commandHelp();
      if (t.startsWith('/img ')) return imgCommand(text.slice(4));
      if (t==='/describe') return describeCommand();
      if (t.startsWith('/explaincode')) return explainCodeCommand(text.slice('/explaincode'.length));
      if (t.startsWith('/fixcode')) return fixCodeCommand(text.slice('/fixcode'.length));
      if (t.startsWith('/createcode')) return createCodeCommand(text.slice('/createcode'.length));
      if (t.startsWith('/format')) return formatCodeCommand(text.slice('/format'.length));
      if (t.startsWith('/calc ')) return calcCommand(text.slice(6));
      if (t.startsWith('/convert ')) return convertCommand(text.slice(9));
      if (t.startsWith('/timer ')) return timerCommand(text.slice(7));
      if (t.startsWith('/weather ')) return weatherCommand(text.slice(9));
      if (t.startsWith('/memory ')) return memoryCommand(text.slice(8));
      if (t.startsWith('/search ')) return searchCommand(text.slice(8));

      const makerTriggers=['who built you','who made you','who created you','your developer','your maker','who is your maker','who is your developer'];
      if (makerTriggers.some(k=>t.includes(k))) return `I was developed by ${POLICY.developerName}.`;

      const companyTriggers=['are you from','which company','what company','openai','google','meta','anthropic','microsoft','x ai','xai'];
      if (companyTriggers.some(k=>t.includes(k))) return `I don't represent any company. If you're asking specifically about my maker, it's ${POLICY.developerName}.`;

      if (/^(hi|hello|hey)\b/i.test(text)) return withPersona('Hello! How can I assist you today?');
      if (t.includes('how are you')) return withPersona("I'm operating normally and ready to help.");

      if (t.includes('what can you do') || t.includes('capabilities')) return withPersona('I can answer questions, draft text, explain/repair/create code, generate and describe images, and use tools like /calc, /convert, /timer, /weather, /search.');

      if (t.startsWith('summarize:')){ const summary=text.slice('summarize:'.length).trim(); return summary ? withPersona(`Summary: ${summary.split(/\s+/).slice(0, 160).join(' ')}${summary.split(/\s+/).length>160?'...':''}`) : 'Provide text after "Summarize:"'; }
      if (t.startsWith('todo:')){ const items=text.slice('todo:'.length).split(',').map(s=>s.trim()).filter(Boolean); if (!items.length) return 'Add items after "Todo:" separated by commas.'; return withPersona('Todo list:\n- '+items.join('\n- ')); }

      if (settings.useMemory && settings.memory){ return withPersona(`Considering your preferences: ${settings.memory.split(/\n/).slice(0,2).join('; ')}. ${"I'm here to help‚Äîwhat would you like to do next?"}`); }

      return withPersona("I'm here to help. Could you clarify your request or provide more details?"); }

    async function modelReply(userText, context){ return Promise.resolve(localReply(userText)); }

    function tryNotify(text){ if(!('Notification' in window)) return; if(Notification.permission==='granted') new Notification(text); else if(Notification.permission!=='denied') Notification.requestPermission(); }

    function fmtDay(ts){ const d=new Date(ts); return d.toLocaleDateString(undefined,{ weekday:'short', year:'numeric', month:'short', day:'numeric' }); }
    function fmtTime(ts){ const d=new Date(ts); return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }

    function shouldGroup(prev, curr){ return prev && prev.role===curr.role && Math.abs((curr.ts||0)-(prev.ts||0))<5*60*1000; }

    function suggestionsFor(text){ const su=['Explain more','Give examples','Turn into action plan','Summarize','Rewrite more concisely']; if (/```/.test(text)) su.unshift('Explain this code','Fix this code'); if (/!\[.*\]\(/.test(text)) su.unshift('Describe this image'); su.unshift('Create image'); return su; }

    function render(){ els.messages.innerHTML=''; let lastDay=''; let prev=null; state.messages.forEach((m)=>{
        const day=fmtDay(m.ts||Date.now()); if(day!==lastDay){ lastDay=day; const sep=document.createElement('div'); sep.className='day-sep'; sep.innerHTML=`<span>${day}</span>`; els.messages.appendChild(sep); }
        const row=document.createElement('div'); row.className=`msg ${m.role}${m.typing?' typing':''}${shouldGroup(prev,m)?' grouped':''}`; prev=m;
        const avatar=document.createElement('div'); avatar.className=`avatar ${m.role==='assistant'?'assistant':'user'}`; avatar.textContent=m.role==='assistant'?(settings.assistantAvatarLabel||'L'):(settings.userAvatarLabel||'U');
        const bubble=document.createElement('div'); bubble.className='bubble';
        if(m.typing){ bubble.classList.add('typing'); bubble.innerHTML='<span>Thinking</span><span class="dots"><span></span><span></span><span></span></span>'; }
        else {
          const content=document.createElement('div'); content.className='content'; content.innerHTML=renderMarkdown(m.content||'');
          bubble.appendChild(content);

          const meta=document.createElement('div'); meta.className='meta'; meta.textContent=fmtTime(m.ts||Date.now()); bubble.appendChild(meta);

          if (m.role==='assistant' && (m.content||'').length>800 && !m.expanded){ bubble.classList.add('collapsed'); const fade=document.createElement('div'); fade.className='fadeout'; bubble.appendChild(fade); const tog=document.createElement('button'); tog.className='toggle-more'; tog.textContent='Show more'; tog.addEventListener('click',()=>{ m.expanded=true; render(); }); bubble.appendChild(tog); }

          const actions=document.createElement('div'); actions.className='msg-actions';
          const copyBtn=document.createElement('button'); copyBtn.className='mini'; copyBtn.textContent='Copy'; copyBtn.addEventListener('click',()=>{ navigator.clipboard.writeText(m.content||''); copyBtn.textContent='Copied'; setTimeout(()=>copyBtn.textContent='Copy',1200); }); actions.appendChild(copyBtn);
          if (m.role==='user'){
            const editBtn=document.createElement('button'); editBtn.className='mini'; editBtn.textContent='Edit & resend'; editBtn.addEventListener('click',()=>{ els.input.value=m.content||''; }); actions.appendChild(editBtn);
          } else {
            const suggs=document.createElement('div'); suggs.className='suggestions'; suggestionsFor(m.content||'').forEach(s=>{ const b=document.createElement('button'); b.className='sugg'; b.textContent=s; b.addEventListener('click',()=>{ if (s==='Create image'){ els.input.value='/img '; } else if (s==='Describe this image'){ els.input.value='/describe'; } else if (s==='Explain this code'){ els.input.value='/explaincode'; } else if (s==='Fix this code'){ els.input.value='/fixcode'; } else { els.input.value = `${s}: `; } els.input.focus(); }); suggs.appendChild(b); }); bubble.appendChild(suggs);
          }
          bubble.appendChild(actions);
        }
        row.appendChild(avatar); row.appendChild(bubble); els.messages.appendChild(row);
      });
      els.messages.querySelectorAll('pre .copy-btn').forEach(btn=>{ btn.addEventListener('click',()=>{ const code=btn.parentElement.querySelector('code').innerText; navigator.clipboard.writeText(code); btn.textContent='Copied'; setTimeout(()=>btn.textContent='Copy',1200); }); });
      els.messages.scrollTop = els.messages.scrollHeight; save(); }

    function setBusy(b){ els.send.disabled=b; els.input.disabled=b; els.micBtn.disabled=b; els.send.textContent=b?'Thinking‚Ä¶':'Send'; }

    async function handleSend(){ let text=els.input.value.trim(); if(!text) return; if (text.length>MAX_MSG_LEN) text = text.slice(0, MAX_MSG_LEN); els.input.value=''; setBusy(true); try { await streamUser(text); showThinking(true); const delay = 1200 + Math.random()*1000 * (1 + settings.creativity/100); await new Promise(r=>setTimeout(r, delay)); const guarded=enforcePolicy(text); let reply=await modelReply(guarded,{ policy:POLICY, rules:getRules(), history:state.messages.filter(m=>!m.typing).slice(-8), persona:settings.persona, tone:settings.tone, creativity:settings.creativity, memory: settings.useMemory?settings.memory:'' }); reply=enforcePolicy(reply,true); reply=enforcePersona(reply); showThinking(false); await streamAssistant(reply); if (els.ttsToggle.checked) speak(reply); } catch(e){ console.error(e); showThinking(false); pushAssistant('An error occurred. Please try again.'); } finally { setBusy(false); } }

    function enforcePersona(text){ const tone=settings.persona||'friendly'; const ends={ friendly:['üôÇ','üòä','üëç'], playful:['üòÑ','üòâ','üéâ'], professional:[], motivational:['üí™','üöÄ','üî•'] }; let t=text.trim(); if (tone==='professional') return t; if (!/[\u2190-\u21FF\u2300-\u23FF\u2460-\u24FF\u2600-\u27BF\u1F300-\u1FAD6]$/.test(t)){ const arr=ends[tone]||ends.friendly; const pick=arr[Math.floor(Math.random()*arr.length)]; t += ` ${pick}`; } return t; }

    function addUser(text){ state.messages.push({ role:'user', content:text, ts:Date.now() }); render(); }
    function pushAssistant(text){ state.messages.push({ role:'assistant', content:text, ts:Date.now() }); render(); }

    async function streamUser(fullText){ const ts=Date.now(); const idx=state.messages.push({ role:'user', content:'', ts })-1; render(); const chars=Array.from(fullText); let out=''; for (let i=0;i<chars.length;i++){ out+=chars[i]; state.messages[idx].content=out; if (i%2===0) render(); await new Promise(r=>setTimeout(r, 3)); } state.messages[idx].content=fullText; render(); }
    async function streamAssistant(fullText){ const ts=Date.now(); const idx=state.messages.push({ role:'assistant', content:'', ts })-1; render(); const chars=Array.from(fullText); let out=''; const base=6; const speed = Math.max(2, base - Math.floor(settings.creativity/34)); for (let i=0;i<chars.length;i++){ out+=chars[i]; state.messages[idx].content=out; if (i%3===0) render(); await new Promise(r=>setTimeout(r, speed)); } state.messages[idx].content=fullText; render(); }

    function showThinking(on){ const exists=state.messages.find(m=>m.typing); if(on){ if(!exists){ state.messages.push({ role:'assistant', typing:true, ts:Date.now(), content:'' }); render(); } } else { const i=state.messages.findIndex(m=>m.typing); if(i!==-1){ state.messages.splice(i,1); render(); } } }

    function getRules(){ const extra=els.rulesInput.value.split(/\n/).map(s=>s.trim()).filter(Boolean); return [...POLICY.baseRules, ...extra]; }

    // Voice input (push-to-talk)
    let recognizing=false; let recognition; function ensureRecognition(){ const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR) return null; if(!recognition){ recognition=new SR(); recognition.continuous=false; recognition.interimResults=true; recognition.lang=navigator.language||'en-US'; recognition.onresult=(e)=>{ let final=''; for(let i=0;i<e.results.length;i++){ const res=e.results[i]; if(res.isFinal) final += res[0].transcript; else els.status.textContent='Listening‚Ä¶ '+res[0].transcript; } els.input.value=(els.input.value+' '+final).trim(); }; recognition.onstart=()=>{ recognizing=true; els.status.textContent='Listening‚Ä¶'; }; recognition.onend=()=>{ recognizing=false; els.status.textContent='Ready'; if (els.input.value.trim()) handleSend(); }; recognition.onerror=()=>{ recognizing=false; els.status.textContent='Mic error'; }; } return recognition; }
    function pttStart(){ const rec=ensureRecognition(); if(!rec){ els.status.textContent='Voice not supported in this browser.'; return;} if(!recognizing) rec.start(); }
    function pttStop(){ if(recognition && recognizing) recognition.stop(); }

    // Voice output controls
    function populateVoices(){ const voices=speechSynthesis.getVoices(); els.voiceSelect.innerHTML=''; for (const v of voices){ const opt=document.createElement('option'); opt.value=v.name; opt.textContent=`${v.name} (${v.lang})`; if(v.name===settings.ttsVoice) opt.selected=true; els.voiceSelect.appendChild(opt);} }
    function speak(text){ if(!('speechSynthesis' in window)) return; const u=new SpeechSynthesisUtterance(text); const voices=speechSynthesis.getVoices(); const chosen=voices.find(v=>v.name===settings.ttsVoice)||voices[0]; if(chosen) u.voice=chosen; u.rate=settings.ttsRate; u.pitch=settings.ttsPitch; speechSynthesis.cancel(); speechSynthesis.speak(u); }

    // File and image import via drag & drop
    function isTextFile(f){ return /\.(txt|md|json|csv|log|html|css|js|py|ts)$/i.test(f.name) || /^text\//.test(f.type) || f.type===''; }
    function isImageFile(f){ return /^image\//.test(f.type) || /\.(png|jpe?g|webp|gif)$/i.test(f.name); }
    function setupDragDrop(){ const overlay=els.dropOverlay; ['dragenter','dragover'].forEach(evt=>{ window.addEventListener(evt,(e)=>{ e.preventDefault(); overlay.classList.add('active'); });}); ['dragleave','drop'].forEach(evt=>{ window.addEventListener(evt,(e)=>{ e.preventDefault(); overlay.classList.remove('active'); });}); window.addEventListener('drop', async (e)=>{ const files=Array.from(e.dataTransfer.files); if(!files.length) return; for(const f of files){ if (isImageFile(f)) { const dataUrl = await fileToDataUrl(f); state.lastImageDataUrl = dataUrl; state.messages.push({ role:'user', content:`Added image: ${f.name}\n\n![${f.name}](${dataUrl})`, ts:Date.now() }); } else if (isTextFile(f)) { if (f.size > MAX_IMPORT_BYTES) { pushAssistant(`Skipped ${f.name}: too large.`); continue; } const text=await f.text(); state.files.push({ name:f.name.slice(0,120), text: text.slice(0, MAX_FILE_CHARS) }); state.messages.push({ role:'user', content:`File: ${f.name}\n\n${text.slice(0, MAX_FILE_CHARS)}`, ts:Date.now() }); } }
        render(); pushAssistant('Item(s) added. Use /describe for images or /search for text files.'); });
      window.addEventListener('paste', async (e)=>{ const item=Array.from(e.clipboardData.items).find(i=>i.kind==='file'); if(item){ const f=item.getAsFile(); if(f){ if (isImageFile(f)){ const dataUrl=await fileToDataUrl(f); state.lastImageDataUrl=dataUrl; state.messages.push({ role:'user', content:`Pasted image\n\n![pasted](${dataUrl})`, ts:Date.now() }); } else if (isTextFile(f)){ if (f.size > MAX_IMPORT_BYTES) { pushAssistant(`Skipped pasted file: too large.`); return; } const text=await f.text(); state.files.push({ name:f.name.slice(0,120), text: text.slice(0, MAX_FILE_CHARS) }); state.messages.push({ role:'user', content:`File: ${f.name}\n\n${text.slice(0, MAX_FILE_CHARS)}`, ts:Date.now() }); } render(); pushAssistant('Pasted item added.'); } } }); }

    function renderChips(){ const chips=[ {t:'Create image',v:'/img '},{t:'Describe image',v:'/describe'},{t:'Explain code',v:'/explaincode'},{t:'Fix code',v:'/fixcode'},{t:'Summarize',v:'Summarize:'},{t:'Create todo',v:'Todo:'},{t:"Explain like I'm 5",v:"Explain like I'm 5: "},{t:'Brainstorm',v:'Brainstorm ideas about '},{t:'Outline',v:'Write an outline for '},{t:'/help',v:'/help'} ]; els.chips.innerHTML=chips.map(c=>`<div class=\"chip\" data-insert=\"${c.v}\">${c.t}</div>`).join(''); }

    // Events
    els.send.addEventListener('click', handleSend);
    els.input.addEventListener('keydown', (e)=>{ if ((e.ctrlKey||e.metaKey) && e.key==='Enter') handleSend(); });
    els.clear.addEventListener('click', ()=>{ state.messages=[{ role:'assistant', content:greet(), ts:Date.now() }]; render(); els.input.focus(); });

    els.themeToggle.addEventListener('click', ()=>{ settings.theme = settings.theme==='dark'?'light':'dark'; applyTheme(); save(); });
    els.accentPicker.addEventListener('input', (e)=>{ applyAccent(e.target.value); save(); });

    els.settingsBtn.addEventListener('click', ()=>{ els.settingsModal.classList.add('active'); els.backdrop.classList.add('active'); });
    els.closeSettings.addEventListener('click', ()=>{ settings.textEndpoint = httpsOrEmpty(els.textEndpoint.value); settings.textApiKey = els.textApiKey.value; settings.imageEndpoint = httpsOrEmpty(els.imageEndpoint.value); settings.imageApiKey = els.imageApiKey.value; settings.visionEndpoint = httpsOrEmpty(els.visionEndpoint.value); settings.visionApiKey = els.visionApiKey.value; settings.codeEndpoint = httpsOrEmpty(els.codeEndpoint.value); settings.codeApiKey = els.codeApiKey.value; els.settingsModal.classList.remove('active'); els.backdrop.classList.remove('active'); updateSettingsFromUI(); save(); });
    els.backdrop.addEventListener('click', ()=>{ els.closeSettings.click(); });

    els.assistantAvatarInput.addEventListener('input', (e)=>{ settings.assistantAvatarLabel=(e.target.value||'L').slice(0,2); els.assistantAvatar.textContent=settings.assistantAvatarLabel; save(); render(); });
    els.userAvatarInput.addEventListener('input', (e)=>{ settings.userAvatarLabel=(e.target.value||'U').slice(0,2); save(); render(); });

    els.voiceSelect.addEventListener('change', (e)=>{ settings.ttsVoice=e.target.value; save(); });
    els.voiceRate.addEventListener('input', (e)=>{ settings.ttsRate=parseFloat(e.target.value)||1; save(); });
    els.voicePitch.addEventListener('input', (e)=>{ settings.ttsPitch=parseFloat(e.target.value)||1; save(); });
    els.ttsToggle.addEventListener('change', (e)=>{ settings.tts=e.target.checked; save(); });
    els.ttsPause.addEventListener('click', ()=>{ if (!('speechSynthesis' in window)) return; if (speechSynthesis.speaking) { if (speechSynthesis.paused) speechSynthesis.resume(); else speechSynthesis.pause(); }});
    els.ttsStop.addEventListener('click', ()=>{ if ('speechSynthesis' in window) speechSynthesis.cancel(); });

    els.persistToggle.addEventListener('change', async (e)=>{ settings.persist=e.target.checked; if(!settings.persist){ localStorage.removeItem(storageKey('assistant_state')); localStorage.removeItem(storageKey('assistant_settings')); } else await save(); });

    els.exportBtn.addEventListener('click', async ()=>{ const data={ settings, messages: state.messages.filter(m=>!m.typing), files: state.files, lastImageDataUrl: state.lastImageDataUrl }; const blob=new Blob([JSON.stringify(data,null,2)],{ type:'application/json' }); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`lumio_export_${currentUser||'guest'}.json`; a.click(); URL.revokeObjectURL(url); });
    els.importFile.addEventListener('change', async (e)=>{ const f=e.target.files[0]; if(!f) return; if (f.size > MAX_IMPORT_BYTES) { alert('Import too large (max ~2MB).'); return; } try { const raw = await f.text(); if (raw.length > MAX_IMPORT_BYTES) { alert('Import too large.'); return; } const j=JSON.parse(raw); if (Array.isArray(j.messages)) state.messages=sanitizeMessages(j.messages); if (Array.isArray(j.files)) state.files=j.files.slice(-MAX_FILES).map(x=>({ name: safeString(x.name||'file',120), text: safeString(x.text||'', MAX_FILE_CHARS) })); if (typeof j.lastImageDataUrl==='string') state.lastImageDataUrl = j.lastImageDataUrl.slice(0, 1_500_000); if (j.settings) settings = { ...settings, ...sanitizeSettings(j.settings) }; applySettingsToUI(); render(); await save(); } catch { alert('Invalid file'); } });

    els.resetBtn.addEventListener('click', async ()=>{ if(!confirm('Reset settings to defaults?')) return; settings={ ...defaultSettings }; applySettingsToUI(); applyTheme(); applyAccent(settings.accent, settings.accent2); await save(); render(); });

    els.chips.addEventListener('click', (e)=>{ const chip=e.target.closest('.chip'); if(!chip) return; const ins=chip.getAttribute('data-insert')||''; els.input.focus(); if (ins==='/help'){ els.input.value='/help'; handleSend(); } else { els.input.value = ins + els.input.value; }});

    els.registerBtn.addEventListener('click', ()=> register(els.regUser.value, els.regPass.value, els.regPass2.value));
    els.loginBtn.addEventListener('click', ()=> login(els.loginUser.value, els.loginPass.value));
    els.logoutBtn.addEventListener('click', logout);

    els.cameraBtn.addEventListener('click', ()=> els.cameraInput.click());
    els.cameraInput.addEventListener('change', async (e)=>{ const f=e.target.files[0]; if (!f) return; if (!isImageFile(f)) return; const dataUrl=await fileToDataUrl(f); state.lastImageDataUrl=dataUrl; state.messages.push({ role:'user', content:`Captured image\n\n![captured](${dataUrl})`, ts:Date.now() }); render(); pushAssistant(withPersona('Nice shot! Use /describe to get details.')); });

    function updateSettingsFromUI(){ settings.extraRules=els.rulesInput.value.split(/\n/).map(s=>s.trim()).filter(Boolean); settings.persona=els.personaSelect.value; settings.tone=parseInt(els.toneLevel.value,10)||defaultSettings.tone; settings.creativity=parseInt(els.creativityLevel.value,10)||defaultSettings.creativity; settings.memory=els.memoryInput.value; settings.useMemory=els.useMemoryToggle.checked; }

    // Init cover by default
    leaveApp();

    if ('serviceWorker' in navigator) { window.addEventListener('load', ()=>{ navigator.serviceWorker.register('sw.js').catch(()=>{}); }); }
    if ('speechSynthesis' in window) { speechSynthesis.onvoiceschanged = populateVoices; populateVoices(); }
    setupDragDrop();
  </script>
</body>
</html>